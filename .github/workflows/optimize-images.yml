name: Optimize Images

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecutarlo manualmente desde la pestaña Actions

permissions:
  contents: write # Permite al bot subir los cambios al repositorio

jobs:
  build:
    name: calibreapp/image-actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Resize Large Images & Generate Thumbnails
        run: |
          # 1. Redimensionar originales a 1920px (si son más grandes)
          find Fotos/ -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) ! -name "*_thumb.*" -exec mogrify -resize '1920>' {} +
          
          # 2. Generar miniaturas de 400px para el grid (antes 800px)
          # Buscamos archivos que NO sean ya miniaturas y creamos su versión _thumb
          find Fotos/ -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) ! -name "*_thumb.*" | while read -r img; do
            thumb="${img%.*}_thumb.${img##*.}"
            if [ ! -f "$thumb" ] || [ "$img" -nt "$thumb" ]; then
              convert "$img" -resize 400 "$thumb"
            fi
          done

      - name: Compress Everything
        uses: calibreapp/image-actions@main
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          compressOnly: true
          jpegQuality: '75'
          pngQuality: '75'
          webpQuality: '75'
          ignorePaths: 'node_modules/**,dist/**'

      - name: Auto Commit Optimized Images
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Optimize images (resize & thumbnails) [skip ci]"
